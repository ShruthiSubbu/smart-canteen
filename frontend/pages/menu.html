<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Canteen â€“ Menu</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body class="menu-page">

  <div class="navbar">
    <h2>ğŸ½ï¸ Smart Canteen</h2>
    <span id="welcomeMsg"></span>
    <div style="display:flex; gap:10px;">
      <button class="logout-btn" onclick="window.location.href='orders.html'">ğŸ“‹ My Orders</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div id="rushBanner" class="rush-banner">
    âš ï¸ Rush Hour! Expect 15-20 min wait. Consider pre-ordering for later!
  </div>

  <div class="menu-container">

    <!-- Pre-order Scheduling -->
    <div class="preorder-bar">
      <label>ğŸ• Schedule Pickup Time:</label>
      <input type="time" id="pickupTimeInput" />
      <span style="font-size:0.85rem; color:#64748b;">Leave empty for ASAP (15 min)</span>
    </div>

    <!-- Recommendations -->
    <div class="category-title">â­ Recommended for You</div>
    <div class="menu-grid" id="recommendations"></div>

    <!-- Main Menu -->
    <div id="menuItems"></div>

  </div>

  <div class="cart-bar">
    <span id="cartInfo">ğŸ›’ Cart: 0 items | â‚¹0</span>
    <button class="checkout-btn" onclick="placeOrder()">Place Order â†’</button>
  </div>

  <script>
    const userData = localStorage.getItem('user');
if (!userData) window.location.href = 'index.html';
const user = JSON.parse(userData);
console.log('Loaded user:', user);
    const token = localStorage.getItem('token');
    if (!user || !token) window.location.href = 'index.html';

    document.getElementById('welcomeMsg').textContent = `ğŸ‘‹ Hi, ${user.name}!`;

    let cart = [];
    let allItems = [];

    const emojis = { breakfast: 'ğŸ³', lunch: 'ğŸ±', snacks: 'ğŸ¿', beverages: 'â˜•' };
    const foodEmojis = {
      'Masala Dosa': 'ğŸ«“', 'Veg Fried Rice': 'ğŸš', 'Samosa': 'ğŸ¥Ÿ',
      'Chai': 'â˜•', 'Paneer Butter Masala': 'ğŸ›', 'Idli Sambar': 'ğŸ½ï¸',
      'Poha': 'ğŸ¥£', 'Veg Biryani': 'ğŸ›', 'Dal Rice': 'ğŸš',
      'Vada': 'ğŸ©', 'Coffee': 'â˜•', 'Lemon Juice': 'ğŸ‹'
    };

    // Toast notification
    function showToast(message, type = 'success') {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    function getPickupTime() {
      const input = document.getElementById('pickupTimeInput').value;
      if (input) return input;
      const now = new Date();
      now.setMinutes(now.getMinutes() + 15);
      return now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function makeCard(item) {
      const emoji = foodEmojis[item.name] || 'ğŸ½ï¸';
      if (!item.isAvailable || item.stockCount <= 0) {
        return `
          <div class="menu-card out-of-stock">
            <span class="food-emoji">${emoji}</span>
            <h4>${item.name}</h4>
            <div class="price">â‚¹${item.price}</div>
            <div class="stock">ğŸ“¦ Stock: 0</div>
            <div class="out-of-stock-badge">âŒ Out of Stock</div>
          </div>`;
      }
      return `
        <div class="menu-card">
          <span class="food-emoji">${emoji}</span>
          <h4>${item.name}</h4>
          <div class="price">â‚¹${item.price}</div>
          <div class="stock">ğŸ“¦ Stock: ${item.stockCount}</div>
          <button class="add-btn" onclick='addToCart(${JSON.stringify(item)})'>+ Add to Cart</button>
        </div>`;
    }
    
    async function loadMenu() {
      try {
        const res = await fetch('http://localhost:3000/api/menu');
        allItems = await res.json();

        // Recommendations â€” top 3 by orderCount
        const recommended = [...allItems]
          .sort((a, b) => b.orderCount - a.orderCount)
          .slice(0, 3);
        document.getElementById('recommendations').innerHTML =
          recommended.map(makeCard).join('');

        // Full menu by category
        const categories = ['breakfast', 'lunch', 'snacks', 'beverages'];
        let html = '';
        categories.forEach(cat => {
          const catItems = allItems.filter(i => i.category === cat);
          if (!catItems.length) return;
          html += `<div class="category-title">${emojis[cat]} ${cat.charAt(0).toUpperCase() + cat.slice(1)}</div>`;
          html += `<div class="menu-grid">${catItems.map(makeCard).join('')}</div>`;
        });
        document.getElementById('menuItems').innerHTML = html;
      } catch (err) {
        showToast('âŒ Failed to load menu. Is server running?', 'error');
      }
    }

    function addToCart(item) {
      const existing = cart.find(c => c.menuItemId === item._id);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({ menuItemId: item._id, name: item.name, price: item.price, quantity: 1 });
      }
      updateCartBar();
      showToast(`âœ… ${item.name} added to cart!`, 'success');
    }

    function updateCartBar() {
      const total = cart.reduce((sum, i) => sum + i.price * i.quantity, 0);
      const count = cart.reduce((sum, i) => sum + i.quantity, 0);
      document.getElementById('cartInfo').textContent =
        `ğŸ›’ ${count} item${count !== 1 ? 's' : ''} | â‚¹${total}`;
    }

    async function placeOrder() {
      console.log('User object:', user);
      if (cart.length === 0) {
        showToast('ğŸ›’ Your cart is empty!', 'error');
        return;
      }

      const pickupTime = getPickupTime();
      const userId = user._id || user.id;

      console.log('Sending userId:', userId);

      showToast('â³ Placing your order...', 'info');

      try {
        const res = await fetch('http://localhost:3000/api/orders/place', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            items: cart,
            pickupTime: pickupTime
          })
        });

        const data = await res.json();
        if (res.ok) {
          showToast(`âœ… Order placed! Pickup at ${pickupTime}`, 'success');
          setTimeout(() => {
            alert(`âœ… Order Confirmed!\nğŸ´ Total: â‚¹${data.order.totalPrice}\nğŸ• Pickup Time: ${pickupTime}\nğŸ“‹ Status: Pending`);
          }, 500);
          cart = [];
          updateCartBar();
          loadMenu();
        } else {
          showToast('âŒ ' + data.message, 'error');
        }
      } catch (err) {
        showToast('âŒ Server error! Please try again.', 'error');
      }
    }

    async function checkRush() {
      try {
        const res = await fetch('http://localhost:3000/api/orders/rush-status');
        const data = await res.json();
        document.getElementById('rushBanner').style.display =
          data.isRush ? 'block' : 'none';
      } catch (err) {
        console.log('Rush check failed');
      }
    }

    loadMenu();
    checkRush();
    setInterval(loadMenu, 30000);
    setInterval(checkRush, 30000);
  </script>

</body>
</html>