<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Canteen â€“ Admin Dashboard</title>
  <link rel="stylesheet" href="../css/style.css">
</head>
<body class="admin-page">

  <div class="navbar">
    <h2>ğŸ½ï¸ Smart Canteen â€“ Admin</h2>
    <span>Dashboard</span>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Stats Row -->
  <div class="admin-stats">
    <div class="stat-card">
      <div class="stat-number" id="totalOrders">0</div>
      <div class="stat-label">ğŸ“‹ Total Orders</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="pendingOrders">0</div>
      <div class="stat-label">â³ Pending</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="totalRevenue">â‚¹0</div>
      <div class="stat-label">ğŸ’° Total Revenue</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="rushStatus">ğŸŸ¢</div>
      <div class="stat-label">Rush Hour Status</div>
    </div>
  </div>

  <!-- Orders List -->
  <div class="orders-container">
    <h3>ğŸ“‹ Incoming Orders <span style="font-size:0.8rem; color:#64748b; font-weight:400;">(auto-refreshes every 10s)</span></h3>
    <div id="ordersList"></div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user || user.role !== 'admin') window.location.href = 'index.html';

    function logout() {
      localStorage.clear();
      window.location.href = 'index.html';
    }

    async function loadOrders() {
      const res = await fetch('http://localhost:3000/api/orders/all');
      const orders = await res.json();

      // Update stats
      document.getElementById('totalOrders').textContent = orders.length;
      document.getElementById('pendingOrders').textContent =
        orders.filter(o => o.status === 'pending').length;
      document.getElementById('totalRevenue').textContent =
        'â‚¹' + orders.reduce((sum, o) => sum + o.totalPrice, 0);

      if (orders.length === 0) {
        document.getElementById('ordersList').innerHTML =
          '<div class="no-orders">ğŸ‰ No orders yet! Waiting for students...</div>';
        return;
      }

      let html = '';
      orders.forEach(order => {
        const items = order.items.map(i => `${i.name} x${i.quantity}`).join(', ');
        const time = new Date(order.createdAt).toLocaleTimeString();
        html += `
          <div class="order-card">
            <h4>Order #${order._id.slice(-6).toUpperCase()}</h4>
            <p>ğŸ´ <strong>Items:</strong> ${items}</p>
            <p>ğŸ’° <strong>Total:</strong> â‚¹${order.totalPrice}</p>
            <p>ğŸ• <strong>Time:</strong> ${time}</p>
            <span class="status-badge status-${order.status}">
              ${order.status.toUpperCase()}
            </span><br/>
            <select class="status-select" onchange="updateStatus('${order._id}', this.value)">
              <option value="pending" ${order.status==='pending'?'selected':''}>â³ Pending</option>
              <option value="preparing" ${order.status==='preparing'?'selected':''}>ğŸ‘¨â€ğŸ³ Preparing</option>
              <option value="ready" ${order.status==='ready'?'selected':''}>âœ… Ready</option>
              <option value="completed" ${order.status==='completed'?'selected':''}>ğŸ‰ Completed</option>
            </select>
          </div>`;
      });

      document.getElementById('ordersList').innerHTML = html;
    }

    async function checkRush() {
      const res = await fetch('http://localhost:3000/api/orders/rush-status');
      const data = await res.json();
      document.getElementById('rushStatus').textContent = data.isRush ? 'ğŸ”´' : 'ğŸŸ¢';
    }

    async function updateStatus(orderId, status) {
      await fetch(`http://localhost:3000/api/orders/status/${orderId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      loadOrders();
    }

    loadOrders();
    checkRush();
    setInterval(loadOrders, 10000);
    setInterval(checkRush, 15000);
  </script>

</body>
</html>